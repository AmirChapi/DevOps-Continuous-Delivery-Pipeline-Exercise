// הגדרת משתנים גלובליים
def dockerImage = 'zip-job-test'
def version = '1.2.0'
def artifactoryServerId = 'Artifactory-TLV-Server' // מזהה השרת מתוך הגדרות Jenkins

// 1: שימוש בפורמט Scripted נכון: node ו-Groovy DSL
node('master') {

    // הגדרת משתני סביבה בתוך ה-Scripted
    env.VERSION = version

    // 1.1: שימוש ב-Docker API של Jenkins כ-Agent
    docker.image(dockerImage).withRun('--privileged -u 0:0') { container ->

        // --- שלב 1: Build & Run Python ---
        stage('Build & Run Python') {
            echo "Running zip_job.py inside Docker image '${dockerImage}'"
            sh 'python3 /tmp/zip_job.py'
            sh 'ls -l *.zip'
        }

        // --- שלב 2: Publish to Artifactory (Plugin) ---
        stage('Publish to Artifactory (Plugin)') {

            // 1. קבלת מופע השרת
            def server = Artifactory.server artifactoryServerId

            // 2. יצירת אובייקט Build Info
            def buildInfo = Artifactory.newBuildInfo()
            buildInfo.name = env.JOB_NAME
            buildInfo.number = env.BUILD_NUMBER

            // 3. העלאת קבצים באמצעות File Specs
            server.upload (
                spec: """{
                    "files": [
                        {
                            "pattern": "*.zip",
                            "target": "binary-storage/${version}/"
                        }
                    ]
                }""",
                buildInfo: buildInfo
            )

            // 4. פרסום המטא-דאטה
            server.publishBuildInfo buildInfo
        }
    } // סגירת בלוק Docker Agent
    
    // --- שלב 3: Cleanup ---
    stage('Cleanup') {
        cleanWs()
    }
    
    // --- שלב 4: Report ---
    stage('Report') {
        def status = currentBuild.result
        mail(
            to: 'amirmalka26@gmail00.com',
            subject: "Job ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${status}",
            body: "Result: ${status}\nConsole log: ${env.BUILD_URL}console"
        )
    }
}