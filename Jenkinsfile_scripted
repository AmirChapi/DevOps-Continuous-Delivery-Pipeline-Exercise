// משתנים גלובליים
def dockerImage = 'zip-job-test'
def version = '1.2.0'
def artifactoryServerId = 'Artifactory-TLV-Server'   // לוודא תואם להגדרת השרת ב-Jenkins
def artRepoKey = 'binary-storage'

node('built-in') {

    env.VERSION = version

    // --- שלב 0: Build Docker Image מה-Dockerfile ---
    stage('Build Docker Image') {
        echo "Building Docker image '${dockerImage}' from Dockerfile..."
        sh """
            docker build -t ${dockerImage} .
        """
    }

    // שימוש ב-docker.image().inside כ"agent"
    docker.image(dockerImage).inside {

        // --- שלב 1: Build & Run Python ---
        stage('Build & Run Python') {
            echo "Running zip_job.py inside Docker image '${dockerImage}'"
            sh 'python3 /tmp/zip_job.py'
            sh 'ls -l *.zip'
        }

        // --- שלב 2: Publish to Artifactory (Plugin) ---
        stage('Publish to Artifactory (Plugin)') {

            def server = Artifactory.server(artifactoryServerId)

            def buildInfo = Artifactory.newBuildInfo()
            buildInfo.name = env.JOB_NAME
            buildInfo.number = env.BUILD_NUMBER

            server.upload(
                spec: """{
                    "files": [
                        {
                            "pattern": "*.zip",
                            "target": "${artRepoKey}/${version}/"
                        }
                    ]
                }""",
                buildInfo: buildInfo
            )

            server.publishBuildInfo(buildInfo)
        }
    }

    // --- שלב 3: Cleanup ---
    stage('Cleanup') {
        cleanWs()
    }

    // --- שלב 4: Report ---
    stage('Report') {
        def status = currentBuild.currentResult
        mail(
            to: 'amirmalka26@gmail.com',
            subject: "Job ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${status}",
            body: "Result: ${status}\nConsole log: ${env.BUILD_URL}console"
        )
    }
}
