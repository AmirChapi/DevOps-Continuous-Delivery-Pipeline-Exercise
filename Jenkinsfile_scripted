// Jenkinsfile_scripted - Final Pipeline Configuration

// הגדרת משתני סביבה גלובליים
def ARTIFACTORY_SERVER_ID = 'artifactory-tlv' // ה-Server ID שהגדרת ב-Configure System
def ARTIFACTORY_CREDENTIAL_ID = 'artifactory-super-user' // ה-Secret text שמכיל את ה-Access Token
def REPO_NAME = 'binary-storage' // שם ה-Repo המקומי ב-Artifactory
def DOCKER_IMAGE_NAME = "zip-job-test"
def DOCKER_TAG = "1.0.${BUILD_NUMBER}" // טאג ייחודי על בסיס מספר ה-Build
def DOCKERFILE_PATH = './Final_hw' // התיקון הקריטי: נתיב לתיקייה המכילה את ה-Dockerfile
def PATH_TO_FILE = "Final_hw/zip_job.py" // הנתיב לקובץ Python שאותו נרצה להעלות ל-Artifactory

node {
    stage('Checkout Code') {
        echo "Obtaining Jenkinsfile from git repository..."
        // ההרשאה לגישה ל-Git מוגדרת דרך SCM ב-Configuration
        checkout scm
    }

    stage('Build Docker Image') {
        echo "Building docker image from ${DOCKERFILE_PATH}..."
        // שימוש בתיקון לנתיב ה-Dockerfile
        bat "docker build -t ${DOCKER_IMAGE_NAME} ${DOCKERFILE_PATH}"
    }

    stage('Publish Artifacts to Artifactory') {
        echo "Publishing zip_job.py to Artifactory..."

        // הגדרת ה-Artifactory Server באמצעות ה-ID שמוגדר במערכת
        def server = Artifactory.server ARTIFACTORY_SERVER_ID

        // 1. פרסום הארטיפקט
        def buildInfo = server.upload(
            // הגדרות העלאה
            repo: REPO_NAME,
            spec: """{
                "files": [
                    {
                        "pattern": "${PATH_TO_FILE}",
                        "target": "py-repo/${DOCKER_IMAGE_NAME}/${DOCKER_TAG}/"
                    }
                ]
            }"""
        )

        // 2. פרסום מידע ה-Build
        buildInfo.env.capture = true
        buildInfo.retention(maxBuilds: 5)
        server.publishBuildInfo buildInfo
    }

    stage('Tag and Push Docker Image') {
        echo "Tagging and pushing Docker image to Artifactory..."

        // 1. יצירת הטאג עבור Artifactory
        def artifactoryRepo = "localhost:8081/docker/${REPO_NAME}" // כתובת Artifactory Docker Repo
        def finalTag = "${artifactoryRepo}/${DOCKER_IMAGE_NAME}:${DOCKER_TAG}"

        // 2. Tag ושליחה (Push)
        bat "docker tag ${DOCKER_IMAGE_NAME} ${finalTag}"

        // 3. Login והעלאה (משתמש ב-Credential שהגדרת: artifactory-super-user)
        docker.withRegistry("http://${artifactoryRepo}", ARTIFACTORY_CREDENTIAL_ID) {
            bat "docker push ${finalTag}"
        }
    }

    stage('Send Notification') {
        echo "Sending success notification..."
        // הודעה על הצלחה (ניתן להוסיף כאן לוגיקה של שליחת מייל)
        currentBuild.result = 'SUCCESS'
    }
}