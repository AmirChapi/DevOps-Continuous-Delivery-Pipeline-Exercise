pipeline {

    // הגדרת משתני סביבה גלובליים
    environment {
        VERSION = '1.2.0'
        // 1. תיקון תקשורת Docker ב-Windows (Named Pipe)
        DOCKER_HOST = 'npipe:////./pipe/docker_engine'

        // הגדרות Artifactory
        ARTIFACTORY_SERVER_ID = 'Artifactory-TLV-Server'
        ART_REPO_KEY = 'binary-storage'
    }

    // Agent מתוקן: הסרת ה-args הכופים כדי למנוע התנגשות נתיבים
    agent {
        docker {
            image 'zip-job-test'
            // 2. הסרת ארגומנטים של נתיבים/Working Directory כדי למנוע כפילות עם ה-C:\
            args "--privileged -u 0:0"
        }
    }

    // Post actions (Email וניקוי Workspace)
    post {
        always {
            // 3. תיקון cleanWs: עוטף את הניקוי בבלוק node כדי לספק Node Context
            node('built-in') {
                cleanWs()
                echo "Pipeline finished cleanup."
            }
        }
        success {
            mail(
                to: 'amirmalka26@gmail00.com',
                subject: "Job ${env.JOB_NAME} - SUCCESS",
                body: "Pipeline completed successfully. Artifacts published to Artifactory."
            )
        }
        failure {
            echo "Pipeline FAILED. Check console output for errors."
        }
    }

    stages {

        // שלב 1: Build & Run Python
        stage('Build & Run Python') {
            steps {
                echo "Running zip_job.py inside Docker image '${agent.image}'"

                // **תיקון קריטי**: משתמש בנתיב /tmp/zip_job.py כפי שהוגדר ב-Dockerfile שלך
                sh 'python3 /tmp/zip_job.py'

                // קבצי ה-.zip נוצרים ב-Workspace הממופה (הנתיב הלינוקסי של C:\...)
                sh 'ls -l *.zip'
            }
        }

        // שלב 2: Publish ל-Artifactory באמצעות פלאגין
        stage('Publish to Artifactory (Plugin)') {
            steps {
                script {
                    def server = Artifactory.server ARTIFACTORY_SERVER_ID
                    def buildInfo = Artifactory.newBuildInfo()
                    buildInfo.name = env.JOB_NAME
                    buildInfo.number = env.BUILD_NUMBER

                    server.upload (
                        spec: """{
                            "files": [
                                {
                                    // הקובץ .zip נמצא ב-Workspace (שמוצמד לקונטיינר)
                                    "pattern": "*.zip",
                                    "target": "${ART_REPO_KEY}/${env.VERSION}/"
                                }
                            ]
                        }""",
                        buildInfo: buildInfo
                    )

                    server.publishBuildInfo buildInfo
                }
            }
        }
    }
}