pipeline {

    // משתני סביבה - שים לב לשינויים הנדרשים:
    environment {
        VERSION = '1.2.0'
        // הערה 1.2: עדיף להשתמש ב-HTTPS (דורש הגדרה ב-Artifactory)
        // לצורך הפשטות, הפלאגין משתמש ב-ID של השרת מתוך הגדרות Jenkins
        ARTIFACTORY_SERVER_ID = 'Artifactory-TLV-Server' // <-- מזהה השרת שהגדרת ב-Manage Jenkins -> System
        ART_CRED_ID = 'artifactory-super-user'
    }

    // 1.1: Agent מתוקן - משתמש באימג' שיצרת
    agent {
        docker {
            image 'zip-job-test' // <--- שם האימג' שיצרת ב-Dockerfile
            args '--privileged -u 0:0'
        }
    }

    // Post actions
    post {
        always {
            cleanWs()
        }
        success {
            echo "Pipeline finished successfully. All ZIPs uploaded!"
            mail(
                to: 'amirmalka26@gmail00.com',
                subject: "Job ${env.JOB_NAME} - SUCCESS",
                body: "Pipeline completed successfully. Artifacts published."
            )
        }
        failure {
            echo "Pipeline FAILED."
        }
    }

    stages {

        stage('Build & Run Python') {
            steps {
                echo "Running zip_job.py inside Docker image '${agent.image}'"
                // הפעלת הסקריפט (שנמצא בתוך הקונטיינר ב-/tmp)
                sh 'python3 /tmp/zip_job.py'
                sh 'ls -l *.zip'
            }
        }

        // 2: שלב Publish מתוקן - שימוש ב-Artifactory Plugin
        stage('Publish to Artifactory (Plugin)') {
            steps {
                script { // נדרש בלוק script כדי להשתמש ב-Groovy DSL של הפלאגין

                    // 1. קבלת מופע השרת מתוך הגדרות Jenkins
                    def server = Artifactory.server ARTIFACTORY_SERVER_ID

                    // 2. יצירת אובייקט Build Info (Metadata)
                    def buildInfo = Artifactory.newBuildInfo()
                    buildInfo.name = env.JOB_NAME
                    buildInfo.number = env.BUILD_NUMBER

                    // 3. העלאת קבצים באמצעות File Specs
                    server.upload (
                        // File Spec: כל קובץ .zip בתיקייה הנוכחית (Workspace)
                        spec: """{
                            "files": [
                                {
                                    "pattern": "*.zip",
                                    "target": "binary-storage/${env.VERSION}/" // נתיב היעד ב-Artifactory
                                }
                            ]
                        }""",
                        buildInfo: buildInfo // צרף את ה-Metadata
                    )

                    // 4. פרסום המטא-דאטה של ה-Build ל-Artifactory
                    server.publishBuildInfo buildInfo
                }
            }
        }
    }
}