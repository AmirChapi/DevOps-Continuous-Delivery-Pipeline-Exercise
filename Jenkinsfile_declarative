pipeline {
    
    environment {
        VERSION = '1.2.0'
        ART_URL = 'http://artifactory-tlv:8081/artifactory'
        ART_REPO = "binary-storage/${env.VERSION}"
        ART_CRED_ID = 'artifactory-super-user'
    }

    agent {
        docker {
            args '--privileged -u 0:0' 
        }
    }
    
    // קובע מה קורה לאחר שה-Pipeline מסתיים (בין אם הצליח או נכשל)
    post {
        always {
            cleanWs()
        }
        success {
            echo "Pipeline finished successfully. All ZIPs uploaded to Artifactory!"
            mail(
                to: 'amirmalka26@gmail.com',
                subject: "Job ${env.JOB_NAME} - SUCCESS",
                body: "Pipeline completed successfully. Check artifacts at Artifactory-TLV."
            )
        }
        failure {
            echo "Pipeline FAILED. Check console output for errors."
        }
    }

    // הגדרת שלבים (Stages)
    stages {
        
        stage('Build & Run Python') {
            steps {
                echo "Running zip_job.py inside Docker image '${agent.image}' with VERSION=${env.VERSION}"
                
                sh 'python3 /tmp/zip_job.py'
                
                sh 'ls -l *.zip'
            }
        }
        
        stage('Publish to Artifactory') {
            steps {
                echo "Uploading zip files to Artifactory URL: ${env.ART_URL}/${env.ART_REPO}"
                
                withCredentials([
                    usernamePassword(
                        credentialsId: env.ART_CRED_ID,
                        usernameVariable: 'ART_USER',
                        passwordVariable: 'ART_PASS'
                    )
                ]) {
                    sh """
                        for f in \$(ls *.zip); do
                            echo Uploading \$f...
                            curl -v -u "${ART_USER}:${ART_PASS}" -T "\$f" "${env.ART_URL}/${env.ART_REPO}/\$f"
                        done
                    """
                }
            }
        }
    }
}